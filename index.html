<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RSI MolKit Viewer</title>
  <link rel="icon" type="image/png" href="rgfavicon.png">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="./3Dmol-min-misaxyz.js"></script>

  <style>
    :root {
      --primary: #006A6A; --on-primary: #ffffff; --primary-container: #9cf1f1; --on-primary-container: #002020;
      --sec-container: #cce8e8; --on-sec-container: #051f1f;
      --surface: #f4fbfb; --surface-container: #eff5f5; --surface-low: #ffffff;
      --on-surface: #161d1d; --on-surface-var: #3f4949; --outline: #6f7979; --error: #ba1a1a;
      --tertiary-container: #dbece0; --warn-container: #ffdbcf; --on-warn-container: #5d1900;
      --chem-n: #3050F8; --chem-f: #00008b; --chem-metal: #FF8C00;
      --sb-width: 320px; --gap: 16px; --rad-l: 24px; --rad-full: 9999px;
    }
    *,*::before,*::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    body { font-family: 'Roboto', sans-serif; background: var(--surface); color: var(--on-surface); height: 100vh; overflow: hidden; display: flex; }
    
    .material-symbols-rounded { font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24; font-size: 22px; }
    
    /* Sidebar */
    #sidebar {
      position: fixed; top: var(--gap); left: var(--gap); bottom: var(--gap); width: var(--sb-width);
      background: var(--surface-container); border-radius: var(--rad-l); display: flex; flex-direction: column;
      z-index: 20; padding: 16px; box-shadow: 0 0 0 1px rgba(0,0,0,0.03), 4px 0 12px rgba(0,0,0,0.05);
    }
    .brand-section { padding: 8px 0 24px; display: flex; justify-content: center; flex-shrink: 0; }
    #rgLogo { height: 48px; width: auto; object-fit: contain; }
    
    /* Input & FAB */
    .fab-container { padding-bottom: 20px; flex-shrink: 0; }
    #fileBtn {
      width: 100%; height: 56px; border-radius: var(--rad-l); border: none; background: var(--primary-container);
      color: var(--on-primary-container); font: 500 16px 'Roboto'; display: flex; align-items: center; justify-content: center;
      gap: 12px; cursor: pointer; position: relative; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    #fileBtn:hover { box-shadow: 0 6px 12px rgba(0,0,0,0.1); transform: translateY(-1px); }

    /* List */
    .list-header { padding: 0 12px 12px; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 700; color: var(--outline); flex-shrink: 0; }
    
    #molList { 
      flex: 1; 
      overflow-y: auto; 
      overflow-x: hidden; 
      display: flex; flex-direction: column; gap: 4px; padding-right: 4px; scroll-behavior: smooth; 
    }
    #molList::-webkit-scrollbar { width: 6px; height: 6px; } 
    #molList::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.15); border-radius: 99px; }
    
    .mol-item {
      position: relative; width: 100%; height: 50px; min-height: 50px; padding: 0 16px; border: none; background: transparent;
      border-radius: var(--rad-full); text-align: left; font: 500 14px 'Roboto'; color: var(--on-surface-var);
      cursor: pointer; display: flex; align-items: center; white-space: nowrap; transition: background-color 0.2s; flex-shrink: 0;
      overflow: hidden;
    }
    .mol-item:hover { background-color: rgba(0, 106, 106, 0.08); }
    .mol-item.active { background-color: var(--sec-container); color: var(--on-sec-container); font-weight: 700; }
    .mol-idx { width: 24px; opacity: 0.5; font-variant-numeric: tabular-nums; flex-shrink: 0; }
    .mol-name { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding-right: 8px; }

    /* Controls */
    #sidebar-footer-group { margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(0,0,0,0.08); display: flex; flex-direction: column; gap: 12px; flex-shrink: 0; }
    #controls { display: flex; gap: 8px; }
    .ctrl-btn {
      flex: 1; height: 44px; border-radius: var(--rad-full); border: 1px solid var(--outline); background: transparent;
      color: var(--on-surface); font-weight: 500; font-size: 13px; cursor: pointer; display: flex; align-items: center; justify-content: center;
      gap: 8px; position: relative; overflow: hidden;
    }
    .ctrl-btn.active-mode { background: var(--on-surface); color: var(--surface); border-color: transparent; }
    .sidebar-copyright { text-align: center; font-size: 11px; color: var(--outline); font-weight: 500; }

    /* Viewer */
    main { margin: var(--gap) var(--gap) var(--gap) calc(var(--sb-width) + (var(--gap)*2)); height: calc(100vh - (var(--gap)*2)); flex: 1; position: relative; display: flex; flex-direction: column; }
    #viewerContainer { width: 100%; height: 100%; position: relative; background: #fff; border-radius: var(--rad-l); overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.03); transform: translateZ(0); }
    #viewer { width: 100%; height: 100%; outline: none; }

    /* Chips */
    #infoPills { position: absolute; bottom: 24px; left: 50%; transform: translateX(-50%); display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; pointer-events: none; width: 90%; }
    .chip {
      background: rgba(255,255,255,0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      padding: 0 20px; height: 36px; border-radius: var(--rad-full); display: flex; align-items: center;
      font: 500 14px 'Roboto'; color: var(--on-surface); box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      border: 1px solid rgba(255,255,255,0.5); pointer-events: auto;
    }
    .chip-details { background: var(--tertiary-container); color: var(--on-sec-container); border: none; }
    .chip-warning { background: var(--warn-container); color: var(--on-warn-container); border: none; }

    /* Ripple */
    .mol-item::after, #fileBtn::after, .ctrl-btn::after {
      content: ""; position: absolute; width: 100%; height: 100%; top: 0; left: 0; pointer-events: none; opacity: 0;
      background: radial-gradient(circle, rgba(0,0,0,0.1) 10%, transparent 10.01%) no-repeat 50%;
      transform: scale(10); transition: transform .5s, opacity 1s;
    }
    .mol-item:active::after, #fileBtn:active::after, .ctrl-btn:active::after { transform: scale(0); opacity: .2; transition: 0s; }
  </style>
</head>
<body>

  <aside id="sidebar">
    <div class="brand-section">
      <img id="rgLogo" src="rglogo.png" alt="RG Logo" onerror="this.style.opacity='0.3'"> 
    </div>
    <div class="fab-container">
      <button id="fileBtn"><span class="material-symbols-rounded">folder_open</span><span>Open .xyz</span></button>
      <input type="file" id="fileInput" accept=".xyz" hidden>
    </div>
    <div class="list-header">Loaded molecules</div>
    <div id="molList"></div>
    <div id="sidebar-footer-group">
      <div id="controls">
        <button id="styleBtn" class="ctrl-btn"><span class="material-symbols-rounded">grain</span><span id="styleTxt">Stick</span></button>
        <button id="labelBtn" class="ctrl-btn"><span class="material-symbols-rounded">label</span><span id="labelTxt">Off</span></button>
      </div>
      <div class="sidebar-copyright">RSI MolKit Viewer v3.0 · Roithová Group 2025</div>
    </div>
  </aside>

  <main>
    <section id="viewerContainer">
      <div id="viewer"></div>
      <div id="infoPills">
        <div id="formulaLabel" class="chip" style="display:none"></div>
        <div id="detailsLabel" class="chip chip-details" style="display:none"></div>
      </div>
    </section>
  </main>

  <script>
    /**
     * Configuration & Constants
     */
    const Config = {
      CSS: {
        N: '#3050F8', F: '#00008b', Metal: '#FF8C00'
      },
      Elements: {
        Sym: ["","H","He","Li","Be","B","C","N","O","F","Ne","Na","Mg","Al","Si","P","S","Cl","Ar","K","Ca","Sc","Ti","V","Cr","Mn","Fe","Co","Ni","Cu","Zn","Ga","Ge","As","Se","Br","Kr","Rb","Sr","Y","Zr","Nb","Mo","Tc","Ru","Rh","Pd","Ag","Cd","In","Sn","Sb","Te","I","Xe","Cs","Ba","La","Ce","Pr","Nd","Pm","Sm","Eu","Gd","Tb","Dy","Ho","Er","Tm","Yb","Lu","Hf","Ta","W","Re","Os","Ir","Pt","Au","Hg","Tl","Pb","Bi","Po","At","Rn","Fr","Ra","Ac","Th","Pa","U","Np","Pu","Am","Cm","Bk","Cf","Es","Fm","Md","No","Lr","Rf","Db","Sg","Bh","Hs","Mt","Ds","Rg","Cn"],
        Metals: new Set(["Li","Be","Na","Mg","Al","K","Ca","Sc","Ti","V","Cr","Mn","Fe","Co","Ni","Cu","Zn","Ga","Rb","Sr","Y","Zr","Nb","Mo","Tc","Ru","Rh","Pd","Ag","Cd","In","Sn","Cs","Ba","La","Ce","Pr","Nd","Pm","Sm","Eu","Gd","Tb","Dy","Ho","Er","Tm","Yb","Lu","Hf","Ta","W","Re","Os","Ir","Pt","Au","Hg","Tl","Pb","Bi","Po","Fr","Ra","Ac","Th","Pa","U","Np","Pu","Am","Cm","Bk","Cf","Es","Fm","Md","No","Lr","Rf","Db","Sg","Bh","Hs","Mt","Ds","Rg","Cn"])
      },
      Modes: {
        Styles: ["Stick", "Ball & Stick"],
        Labels: ["Off", "Atom", "Index"]
      },
      Defaults: [
        { name: "Water", xyz: "3\nWater\nO 0.000000 0.000000 0.000000\nH 0.758602 0.000000 0.504284\nH 0.758602 0.000000 -0.504284" },
        { name: "Methane", xyz: "5\nMethane\nC 0.000000 0.000000 0.000000\nH 0.629118 0.629118 0.629118\nH -0.629118 -0.629118 0.629118\nH 0.629118 -0.629118 -0.629118\nH -0.629118 0.629118 -0.629118" },
        { name: "Benzene", xyz: "12\nBenzene\nC -1.2131 -0.6884 0.0000\nC -1.2028 0.7064 0.0001\nC -0.0103 -1.3948 0.0000\nC 0.0104 1.3948 -0.0001\nC 1.2028 -0.7063 0.0000\nC 1.2131 0.6884 0.0000\nH -2.1577 -1.2244 0.0000\nH -2.1393 1.2564 0.0001\nH -0.0184 -2.4809 -0.0001\nH 0.0184 2.4808 -0.0002\nH 2.1394 -1.2563 0.0001\nH 2.1577 1.2245 0.0001" },
      ]
    };

    /**
     * Data Logic: Parsing & Molecule Structure
     */
    class XYZParser {
      static parse(text) {
        const lines = text.replace(/\r/g, "").split("\n");
        const molecules = [];
        let i = 0, count = 0;
        const detailsRegex = /^(.*?)\s*\|\s*E\(HF\)=([\-\d.]+)\s*\|\s*E\(0K\)=([\-\d.]+)\s*\|\s*Imag=([\-\d.]+)/i;

        while(i < lines.length) {
          const lineTrim = lines[i]?.trim();
          if(!/^\d+$/.test(lineTrim)) { i++; continue; }
          
          const atomCount = +lineTrim;
          const header = (lines[i+1] || "").trim();
          let mol = { 
            header, 
            displayName: header || `Molecule ${++count}`, 
            atoms: [], 
            xyzBlock: "",
            details: null,
            error: null 
          };

          try {
            if (atomCount <= 0 || i + 2 + atomCount > lines.length) throw new Error("Incomplete data block");

            const rawXYZ = [];
            for (let j = 0; j < atomCount; j++) {
              const parts = lines[i + 2 + j].trim().split(/\s+/);
              if (parts.length < 4) throw new Error("Malformed atom line");
              
              const rawEl = parts[0];
              const el = /^\d+$/.test(rawEl) ? Config.Elements.Sym[+rawEl] || "X" : rawEl;
              
              mol.atoms.push({ elem: el, x: +parts[1], y: +parts[2], z: +parts[3] });
              rawXYZ.push(`${el} ${parts[1]} ${parts[2]} ${parts[3]}`);
            }

            // Extract RSI-specific energy details
            const match = header.match(detailsRegex);
            if (match) {
              mol.details = { name: match[1].trim(), ehf: +match[2], e0k: +match[3], imag: +match[4] };
              mol.displayName = mol.details.name;
            }
            mol.xyzBlock = `${atomCount}\n${header}\n${rawXYZ.join("\n")}\n`;
            i += atomCount + 2;

          } catch (e) {
            mol.error = e.message;
            i += 1; // Try to recover on next line
          }
          molecules.push(mol);
        }
        return molecules;
      }
    }

    /**
     * Renderer: Wraps 3Dmol.js interactions
     */
    class MolRenderer {
      constructor(containerId) {
        this.viewer = $3Dmol.createViewer(containerId, { backgroundColor: "white" });
        if(this.viewer.setFog) this.viewer.setFog(0.4, 1);
        
        this.model = null;
        this.styleMode = 0; // 0: Stick, 1: Ball&Stick
        this.labelMode = 0; // 0: Off, 1: Atom, 2: Index
        
        // Handle resizing
        window.addEventListener('resize', () => this.viewer.resize());
      }

      load(xyzData) {
        this.viewer.clear();
        this.model = this.viewer.addModel(xyzData, "xyz");
        this.applyStyle();
        this.applyLabels();
        this.viewer.zoomTo();
        this.viewer.render();
      }

      setStyle(modeIndex) {
        this.styleMode = modeIndex;
        if(this.model) {
          this.applyStyle();
          this.viewer.render();
        }
      }

      setLabelMode(modeIndex) {
        this.labelMode = modeIndex;
        if(this.model) {
          this.viewer.removeAllLabels(); // Optimized cleanup
          this.applyLabels();
          this.viewer.render();
        }
      }

      applyStyle() {
        if(!this.model) return;
        const stick = { radius: 0.12 };
        const sphere = { scale: 0.23 };
        const hSphere = { scale: 0.15 };

        // Base Style
        if (this.styleMode === 0) {
          this.model.setStyle({}, { stick }); 
        } else {
          this.model.setStyle({}, { stick, sphere });
          this.model.setStyle({ elem: "H" }, { stick, sphere: hSphere });
        }

        // Coloring Overrides
        const setC = (sel, c) => {
          const s = this.styleMode === 0 ? { stick: { ...stick, color: c } } : { stick: { ...stick, color: c }, sphere: { ...sphere, color: c } };
          this.model.setStyle(sel, s);
        };

        setC({ elem: "N" }, Config.CSS.N);
        setC({ elem: "F" }, Config.CSS.F);
        Config.Elements.Metals.forEach(e => setC({ elem: e }, Config.CSS.Metal));
      }

      applyLabels() {
        if (!this.model || this.labelMode === 0) return;
        
        const props = { fontSize: 12, fontColor: "#000", backgroundColor: "#fff", backgroundOpacity: 0.7, inFront: true, borderThickness: 0 };
        const atoms = this.model.selectedAtoms({});
        
        atoms.forEach((a, i) => {
          const txt = this.labelMode === 2 ? String(i + 1) : a.elem;
          this.viewer.addLabel(txt, { ...props, position: { x: a.x, y: a.y, z: a.z } });
        });
      }
    }

    /**
     * Interface: Handles DOM manipulations and events
     */
    class UIManager {
      constructor(callbacks) {
        this.cb = callbacks;
        this.dom = {
          fileBtn: document.getElementById("fileBtn"),
          fileInput: document.getElementById("fileInput"),
          molList: document.getElementById("molList"),
          styleBtn: document.getElementById("styleBtn"),
          styleTxt: document.getElementById("styleTxt"),
          labelBtn: document.getElementById("labelBtn"),
          labelTxt: document.getElementById("labelTxt"),
          pills: {
            formula: document.getElementById("formulaLabel"),
            details: document.getElementById("detailsLabel")
          }
        };

        this.attachEvents();
      }

      attachEvents() {
        this.dom.fileBtn.onclick = () => this.dom.fileInput.click();
        
        this.dom.fileInput.onchange = (e) => {
          if (e.target.files[0]) this.cb.onFileLoad(e.target.files[0]);
        };

        this.dom.styleBtn.onclick = () => this.cb.onToggleStyle();
        this.dom.labelBtn.onclick = () => this.cb.onToggleLabel();
      }

      renderList(molecules, activeIndex) {
        this.dom.molList.innerHTML = "";
        molecules.forEach((m, i) => {
          const btn = document.createElement("button");
          btn.className = `mol-item ${i === activeIndex ? 'active' : ''}`;
          
          const icon = m.error 
            ? `<span class="material-symbols-rounded mol-idx" style="color:var(--error)">warning</span>`
            : `<span class="mol-idx">${i + 1}.</span>`;
            
          btn.innerHTML = `${icon} <span class="mol-name">${m.displayName.replace(/\.log$/, '')}</span>`;
          btn.title = m.error || m.displayName;
          
          if (!m.error) btn.onclick = () => this.cb.onSelectMol(i);
          this.dom.molList.appendChild(btn);
        });
      }

      updateControls(styleIdx, labelIdx) {
        this.dom.styleTxt.textContent = Config.Modes.Styles[styleIdx];
        this.dom.labelTxt.textContent = Config.Modes.Labels[labelIdx];
        this.dom.labelBtn.classList.toggle("active-mode", labelIdx !== 0);
      }

      updatePills(mol) {
        const { formula, details } = this.dom.pills;
        if (!mol) {
          formula.style.display = details.style.display = "none";
          return;
        }

        // Formula Calculation
        const counts = {};
        mol.atoms.forEach(a => counts[a.elem] = (counts[a.elem] || 0) + 1);
        const sortedKeys = Object.keys(counts).sort((a,b) => a==='C'?-1:b==='C'?1:a==='H'?1:b==='H'?-1:a.localeCompare(b));
        
        formula.innerHTML = sortedKeys.map(k => `${k}${counts[k] > 1 ? `<sub>${counts[k]}</sub>` : ''}`).join("");
        formula.style.display = "flex";

        // Details Logic
        if (mol.isDefault) {
          details.className = "chip chip-warning";
          details.innerHTML = `<span class="material-symbols-rounded" style="font-size:18px; margin-right:6px">info</span> Viewing Default Data`;
          details.style.display = "flex";
        } else if (mol.details) {
          details.className = "chip chip-details";
          details.innerHTML = `
            <span style="opacity:0.7">E(HF):</span>&nbsp;${mol.details.ehf.toFixed(2)}&nbsp;|&nbsp;
            <span style="opacity:0.7">E(0K):</span>&nbsp;${mol.details.e0k.toFixed(2)}&nbsp;|&nbsp;
            <span style="opacity:0.7">Imag:</span>&nbsp;${mol.details.imag}
          `;
          details.style.display = "flex";
        } else {
          details.style.display = "none";
        }
      }
    }

    /**
     * Application: State & Orchestration
     */
    class App {
      constructor() {
        this.renderer = new MolRenderer("viewer");
        this.molecules = [];
        this.state = {
          currentIdx: -1,
          styleMode: 0,
          labelMode: 0
        };

        // Initialize UI with callback bindings
        this.ui = new UIManager({
          onFileLoad: (file) => this.handleFile(file),
          onSelectMol: (idx) => this.selectMolecule(idx),
          onToggleStyle: () => this.cycleStyle(),
          onToggleLabel: () => this.cycleLabel()
        });

        // Load Defaults
        this.loadDefaults();
      }

      loadDefaults() {
        const parsed = Config.Defaults.map(d => {
          const p = XYZParser.parse(d.xyz)[0];
          p.displayName = d.name;
          p.isDefault = true;
          return p;
        });
        this.updateMolecules(parsed);
      }

      handleFile(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          const parsed = XYZParser.parse(e.target.result);
          if (parsed.length) this.updateMolecules(parsed);
        };
        reader.readAsText(file);
      }

      updateMolecules(newList) {
        this.molecules = newList.sort((a, b) => (a.details?.e0k ?? 9e5) - (b.details?.e0k ?? 9e5));
        const firstValid = this.molecules.findIndex(m => !m.error);
        if (firstValid !== -1) this.selectMolecule(firstValid);
        else this.ui.renderList(this.molecules, -1);
      }

      selectMolecule(idx) {
        if (!this.molecules[idx] || this.molecules[idx].error) return;
        
        this.state.currentIdx = idx;
        const mol = this.molecules[idx];
        
        this.renderer.load(mol.xyzBlock);
        this.ui.renderList(this.molecules, idx);
        this.ui.updatePills(mol);
      }

      cycleStyle() {
        this.state.styleMode = (this.state.styleMode + 1) % 2;
        this.renderer.setStyle(this.state.styleMode);
        this.ui.updateControls(this.state.styleMode, this.state.labelMode);
      }

      cycleLabel() {
        this.state.labelMode = (this.state.labelMode + 1) % 3;
        this.renderer.setLabelMode(this.state.labelMode);
        this.ui.updateControls(this.state.styleMode, this.state.labelMode);
      }
    }

    // Launch
    window.onload = () => new App();

  </script>
</body>
</html>
